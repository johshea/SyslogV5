{% extends "base.html" %}
{% block content %}
<div class="d-flex align-items-center mb-3">
  <h2 class="mb-0">Events</h2>
  <span class="ms-3 text-muted small">Use filters below to narrow results.</span>
</div>

<!-- Sticky / collapsible search bar -->
<div class="sticky-search shadow-sm border-bottom">
  <div class="d-lg-none d-flex justify-content-between align-items-center">
    <strong class="text-muted">Search &amp; Filters</strong>
    <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#searchCollapse" aria-expanded="true" aria-controls="searchCollapse">
      <span id="searchChevron" class="chev" aria-hidden="true">▾</span>
    </button>
  </div>
  <div id="searchCollapse" class="collapse show dont-collapse-lg">
    <form method="get" class="mb-3">
      <div class="input-group">
        <input class="form-control" name="q" value="{{ args.get('q','') }}" placeholder="Search messages">
        <button class="btn btn-primary" type="submit">Search</button>
        <a class="btn btn-outline-secondary" href="{{ url_for('index') }}">Clear</a>
      </div>
      {# preserve other filters when searching #}
      {% for k, v in args.items() %}
        {% if k not in ['q','page'] and v %}
          <input type="hidden" name="{{ k }}" value="{{ v }}">
        {% endif %}
      {% endfor %}
    </form>
  </div>
</div>

<!-- Filters card -->
<div class="card shadow-sm mb-3">
  <div class="card-body">
    <form method="get" class="row g-2">
      <div class="col-sm-2"><input class="form-control" name="host" value="{{ args.get('host','') }}" placeholder="Host"></div>
      <div class="col-sm-2"><input class="form-control" name="app" value="{{ args.get('app','') }}" placeholder="App"></div>
      <div class="col-sm-2"><input class="form-control" name="srcip" value="{{ args.get('srcip','') }}" placeholder="Source IP"></div>
      <div class="col-sm-1"><input class="form-control" name="severity" value="{{ args.get('severity','') }}" placeholder="Sev"></div>
      <div class="col-sm-1"><input class="form-control" name="facility" value="{{ args.get('facility','') }}" placeholder="Fac"></div>
      <div class="col-sm-1">
        <select class="form-select" name="proto">
          <option value="">Proto</option>
          <option value="UDP" {% if args.get('proto')=='UDP' %}selected{% endif %}>UDP</option>
          <option value="TCP" {% if args.get('proto')=='TCP' %}selected{% endif %}>TCP</option>
        </select>
      </div>
      <div class="col-md-3"><input class="form-control" type="datetime-local" name="start" value="{{ args.get('start','') }}" placeholder="Start"></div>
      <div class="col-md-3"><input class="form-control" type="datetime-local" name="end" value="{{ args.get('end','') }}" placeholder="End"></div>
      <div class="col-sm-2">
        <select class="form-select" name="sort">
          {% set sort = args.get('sort','received_at') %}
          <option value="received_at" {{ 'selected' if sort=='received_at' else '' }}>Sort: Time</option>
          <option value="host" {{ 'selected' if sort=='host' else '' }}>Host</option>
          <option value="app" {{ 'selected' if sort=='app' else '' }}>App</option>
          <option value="severity" {{ 'selected' if sort=='severity' else '' }}>Severity</option>
          <option value="facility" {{ 'selected' if sort=='facility' else '' }}>Facility</option>
          <option value="source_ip" {{ 'selected' if sort=='source_ip' else '' }}>Source IP</option>
          <option value="protocol" {{ 'selected' if sort=='protocol' else '' }}>Protocol</option>
        </select>
      </div>
      <div class="col-sm-2">
        <select class="form-select" name="order">
          {% set order = args.get('order','desc') %}
          <option value="desc" {{ 'selected' if order=='desc' else '' }}>Desc</option>
          <option value="asc" {{ 'selected' if order=='asc' else '' }}>Asc</option>
        </select>
      </div>
      <div class="col-sm-2"><input class="form-control" name="per_page" value="{{ args.get('per_page','50') }}" placeholder="Per page"></div>
      <div class="col-sm-2 d-grid"><button class="btn btn-primary" type="submit">Apply</button></div>
      <div class="col-sm-2 d-grid">
        <a class="btn btn-outline-secondary" href="{{ url_for('export_csv') }}?{{ request.query_string.decode() }}">Export CSV</a>
      </div>
      <div class="col-sm-2 d-grid">
        <a class="btn btn-outline-light border" href="{{ url_for('index') }}">Reset</a>
      </div>
    </form>
  </div>
</div>

<!-- Updated indicator + table -->
<div class="d-flex justify-content-end align-items-center mb-2">
  <span id="update-indicator" class="small text-muted">—</span>
</div>
<div id="events-table-wrap">{% include "events_table.html" %}</div>

<script>
(function(){
  // Chevron rotate on collapse
  var col = document.getElementById('searchCollapse');
  var chev = document.getElementById('searchChevron');
  if (col && chev) {
    function setChevron(){ if (col.classList.contains('show')) chev.classList.remove('rot'); else chev.classList.add('rot'); }
    col.addEventListener('shown.bs.collapse', setChevron);
    col.addEventListener('hidden.bs.collapse', setChevron);
    setChevron();
  }

  // Live refresh + "Updated just now"
  const wrap = document.getElementById('events-table-wrap');
  const ind = document.getElementById('update-indicator');
  if (!wrap) return;
  function markUpdated(){
    if (!ind) return;
    const t = new Date();
    ind.textContent = 'Updated just now (' + t.toLocaleTimeString() + ')';
    ind.classList.add('flash');
    setTimeout(()=>ind.classList.remove('flash'), 700);
  }
  async function refresh(){
    try {
      const qs = window.location.search ? window.location.search.substring(1) : '';
      const resp = await fetch('/events/fragment' + (qs ? ('?' + qs) : ''), {cache: 'no-store'});
      if (!resp.ok) return;
      const html = await resp.text();
      wrap.innerHTML = html;
      markUpdated();
    } catch(e){ /* ignore transient errors */ }
  }
  setInterval(refresh, 10000);
  refresh();
})();
</script>

{% endblock %}
